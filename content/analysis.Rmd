---
title: Analysis
description:
toc: true
featuredVideo:
featuredImage: https://s.marketwatch.com/public/resources/images/MW-BV988_sat_te_MG_20140305143435.jpg
draft: false
---
We describe here our detailed data analysis.

```{r}
library(tidyverse)
print(getwd())
data <- read_csv(here::here("dataset/school_scores_data_clean.csv"))
load(here::here("dataset/school_scores.RData"))
print(ls())
```

-------
The variables we are most interested in are total math and verbal SAT scores as well as family income — namely, we want to examine whether or not there exists a statistically significant relationship between family income and SAT scores, and the form of these relationships (i.e., linear, logistic, etc.). Over the past several years, more and more questions have arose regarding whether or not colleges (and the rest of the world) should be looking at SAT scores as a credible measure of aptitude and intelligence, or if they are simply another tool for the privileged to remain at the top. 

Some questions we would like to answer are:

1. What is the nature of the relationship between family income and SAT scores?
2. Is this relationship statistically significant?
3. Are there differences in income and SAT scores between states? 
4. Is performance in certain subjects more sensitive to changes in family income than others (e.g., math vs. English)?
5. Is GPA more affected by family income than SAT scores?

```{r new data}
library(stringr)
schooldata <- read_csv(here::here("dataset/school_scores_data_clean.csv"))
schooldatacleaned <- read_csv(here::here("dataset/schooldatacleaned.csv"))
schooldatacleaned_math <- schooldatacleaned %>% 
  select(year,"state.code","income.less.than.20k.math", "income.between.20.40k.math", "income.between.40.60k.math", "income.between.60.80k.math", "income.between.80.100k.math", "income.more.than.100k.math") %>%
  pivot_longer(c(income.less.than.20k.math, income.between.20.40k.math, income.between.40.60k.math, income.between.60.80k.math, income.between.80.100k.math, income.more.than.100k.math), 
               names_to = "income.bracket.math", 
               values_to = "average.math.score.of.bracket", 
               values_drop_na = TRUE) %>%
  mutate(income.bracket = str_remove(income.bracket.math, ".math")) %>%
  select("state.code", "income.bracket","average.math.score.of.bracket") 
schooldatacleaned_math

schooldatacleaned_verbal <- schooldatacleaned %>% 
  select(year,"state.code","income.less.than.20k.verbal", "income.between.20.40k.verbal", "income.between.40.60k.verbal", "income.between.60.80k.verbal", "income.between.80.100k.verbal", "income.more.than.100k.verbal") %>%
  pivot_longer(c(income.less.than.20k.verbal, income.between.20.40k.verbal, income.between.40.60k.verbal, income.between.60.80k.verbal, income.between.80.100k.verbal, income.more.than.100k.verbal), 
               names_to = "income.bracket.verbal", 
               values_to = "average.verbal.score.of.bracket", 
               values_drop_na = TRUE) %>%
  mutate(income.bracket = str_remove(income.bracket.verbal, ".verbal")) %>%
  select("state.code", "income.bracket", "average.verbal.score.of.bracket")
schooldatacleaned_verbal

schooldatacleaned_math$average.verbal.score.of.bracket <- schooldatacleaned_verbal$average.verbal.score.of.bracket
schooldatacleaned <- schooldatacleaned_math %>% 
  bind_cols(schooldatacleaned_verbal$average.verbal.score.of.bracket) %>%
  select("state.code", "income.bracket", "average.math.score.of.bracket", "average.verbal.score.of.bracket")
schooldatacleaned
```

```{r model 1}
# this needs to be fixed — use something other than geom_col
sixstates <- c("MD", "NJ", "MA", "AR", "WV", "MS")
schooldata6 <- schooldata %>% 
  filter(State.Code %in% sixstates) %>% 
  mutate(Total.Score = Total.Math + Total.Verbal) %>% 
  select("State.Code", "Total.Score") %>% 
  group_by(State.Code) %>% 
  transmute(avg.total.score = mean(Total.Score))
schooldata6

ggplot(data = schooldata6, mapping = aes(x = State.Code, y = avg.total.score, fill = State.Code)) + 
  geom_col(aes(color = State.Code))
```

Our first model takes the three U.S. states with the highest median household income and the three with the lowest and plots them against their average SAT scores. We can see that this plot does not support our conjecture that higher family incomes lead to higher SAT scores, as the scores for Arkansas and Mississippi, two of the states with the lowest median household income in the country, have higher average SAT scores than all three states with the highest median household incomes. 

```{r model 2}
# this needs to be fixed — use something other than geom_col
# Big Picture page idea: put the lowest and highest brackets
schooldatacleaned <- schooldatacleaned %>% 
  mutate(average.total.score.of.bracket = average.math.score.of.bracket + average.verbal.score.of.bracket) %>% 
  select("state.code", "income.bracket", "average.total.score.of.bracket") %>% 
  group_by(income.bracket) 
schooldatacleaned

ggplot(data = schooldatacleaned, 
       mapping = aes(x = income.bracket, 
                     y = average.total.score.of.bracket, 
                     fill = income.bracket)) + 
  geom_col(aes(color = income.bracket)) + 
  labs(x = "Income Bracket", y = "Average SAT Score of Bracket") 
```

Model 2 examines the relationship between income bracket and average SAT score. Clearly, we see a steady rise in SAT score as the income bracket increases, which does support our hypothesis that income is the best predictor of SAT score. Interestingly, the biggest gap in SAT scores seems to be in between the "income under 20k" and the "income between 20 and 40k" brackets, which could indicate that those in the lowest income bracket faces the most difficulty in doing well on the exam. This makes sense, as there have been many studies showing that the stress of living in poverty negatively affects how one's brain functions. 

```{r model 2 inference}
income <- c(20000, 40000, 60000, 80000, 100000)
incomescore <- c(936, 1040, 1090, 1114, 1143)
lm2 <- data.frame(cbind(income, incomescore))
summary(lm(incomescore ~ income, lm2))
```

We see here that there is a very strong positive correlation between income bracket and SAT score, as the R^2 value is very high and the absolute value of the t-stat for income is greater than 2.



This model is a more in-depth look at the differences in SAT scores across different states. 

```{r model 4}
# map of average total score by state
library(maps)

schooldata4 <- schooldata %>% 
  mutate(Total.Score = Total.Math + Total.Verbal) %>% 
  select("State.Name", "Total.Score") %>% 
  group_by(State.Name) %>% 
  transmute(avg.total.score = mean(Total.Score), State.Name)
schooldata4 <- unique(schooldata4)

MainStates <- map_data("state")
states <- MainStates %>% transmute(region) %>% unique()
schooldata4 <- schooldata4 %>% transmute(region = str_to_lower(State.Name), avg.total.score) %>% 
  filter(region %in% states$region)

MergedStates <- inner_join(MainStates, schooldata4, by = "region")

ggplot() + geom_polygon(data = MergedStates, aes(x = long, y = lat, group = group, 
                                                 fill = avg.total.score), color = "white") +
  scale_fill_continuous(low = "springgreen", high = "springgreen4", name = "Average SAT Score") + 
  labs(title = "Average SAT Score by State")
                          
```

Similar to Model 3, Model 4 takes a look at the average SAT score in every state, but in a more digestible and aesthetically pleasing map form. We see that states in the midwest tend to have higher average SAT score.

```{r model 5}
# use facet_grid later to put all plots into a matrix
west <- c("WA","OR", "ID", "MT", "WY", "CA", "NV", "UT", "CO")
southwest <- c("AZ", "NM", "OK", "TX")
midwest <- c("ND", "SD", "NE", "KS", "MN", "IA", "MO", "WI", "IL", "MI", "IN", "OH")
southeast <- c("LA", "MS", "TN", "KY", "WV", "VA", "NC", "SC", "AL", "GA", "FL", "AR")
northeast <- c("MA", "MD", "DE", "NJ", "ME", "VT", "NH", "PA", "NY", "CT", "RI")
continental_us <- c(west, southwest, midwest, southeast, northeast)
state_codes <- schooldata %>% select(State.Code) %>% unique() %>% filter(State.Code %in% continental_us)

schooldata5 <- schooldata %>% mutate(Total.Score = Total.Math + Total.Verbal) %>% select("State.Code", "Total.Score", "Year") %>% add_column(region = NA) %>% mutate(region = ifelse(State.Code %in% west, "west", region)) %>% mutate(region = ifelse(State.Code %in% southwest, "southwest", region)) %>% mutate(region = ifelse(State.Code %in% midwest, "midwest", region)) %>% mutate(region = ifelse(State.Code %in% southeast, "southeast", region)) %>% mutate(region = ifelse(State.Code %in% northeast, "northeast", region)) %>% group_by(region)

continental_us <- schooldata$State.Code %>% unique()
#continental_us

facet_grid(Total.Score ~ State.Code, facets = "region")
par(mfrow = c(2,3))

schooldata5 %>% filter(region == "west") %>%
  ggplot(aes(x = State.Code , y = Total.Score)) + geom_point()

schooldata5 %>% filter(region == "southwest") %>%
  ggplot(aes(x = State.Code , y = Total.Score)) + geom_point()

schooldata5 %>% filter(region == "midwest") %>%
  ggplot(aes(x = State.Code , y = Total.Score)) + geom_point()

schooldata5 %>% filter(region == "southeast") %>%
  ggplot(aes(x = State.Code , y = Total.Score)) + geom_point()

schooldata5 %>% filter(region == "northeast") %>%
  ggplot(aes(x = State.Code , y = Total.Score)) + geom_point()
```

This is a matrix of average SAT scores by state, split into the 5 regions of the continental United States. Just as in Model 4, we see that the Midwest generally have higher average scores. 

```{r backwards selection}
library(leaps)

bs <- leaps::regsubsets(
  average.total.score.of.bracket ~ .,
  method = "backward",
  data = schooldatacleaned
)

summary(bs)$which
summary(bs)$cp

```

Lastly, we decided to use backward selection to drop any predictor variables that made our model less precise. Our model 8 is the best model from the output since it has the lowest Mallow's CP value, and contains all the income bracket variables, indicating that income is indeed a good predictor of SAT scores. 

```