---
title: Analysis
description:
toc: true
featuredVideo:
featuredImage: https://s.marketwatch.com/public/resources/images/MW-BV988_sat_te_MG_20140305143435.jpg
draft: false
---
We describe here our detailed data analysis.

```{r}
library(tidyverse)
print(getwd())
data <- read_csv(here::here("dataset/school_scores_data_clean.csv"))
load(here::here("dataset/school_scores.RData"))
print(ls())
```

-------
## Data Description:

The variables we are most interested in are total math and verbal SAT scores as well as family income — namely, we want to examine whether or not there exists a statistically significant relationship between family income and SAT scores, and the form of these relationships (i.e., linear, logistic, etc.). Over the past several years, more and more questions have arose regarding whether or not colleges (and the rest of the world) should be looking at SAT scores as a credible measure of aptitude and intelligence, or if they are simply another tool for the privileged to remain at the top. 

## Important Questions:

Some questions we would like to answer are:

1. What is the nature of the relationship between family income and SAT scores?
2. Is this relationship statistically significant?
3. Are there differences in income and SAT scores between states? 
4. Is GPA more affected by family income than SAT scores?
5. Are other factors, like gender and GPA, better predictors of SAT scores?
6. Do any of these relationships change over time?

### Figure 1: Six States Comparison

We began our exploratory data analysis by examining the average SAT score across six different states: the three states with the highest median household incomes, and the three states with the lowest median household incomes.

```{r figure 1}
# this needs to be fixed — use summarize, not geom_col or geom_bar
schooldata <- read_csv(here::here("dataset/school_scores_data_clean.csv"))
sixstates <- c("MD", "NJ", "MA", "AR", "WV", "MS")

schooldata6 <- schooldata %>% 
  filter(State.Code %in% sixstates) %>% 
  mutate(Total.Score = Total.Math + Total.Verbal) %>% 
  select("State.Code", "Total.Score") %>% 
  group_by(State.Code) %>% 
  transmute(avg.total.score = mean(Total.Score)) %>%
  group_by(State.Code, avg.total.score) %>%
  summarise(avg.total.score = mean(avg.total.score))
schooldata6

ggplot(data = schooldata6, mapping = aes(x = State.Code, y = avg.total.score, fill = State.Code)) + 
  geom_col(aes(color = State.Code))
```

We can see that this plot does not support our conjecture that higher family incomes lead to higher SAT scores, as the scores for Arkansas and Mississippi, two of the states with the lowest median household income in the country, have higher average SAT scores than all three states with the highest median household incomes. We then wanted to see if any states in particular had higher SAT scores, so we decided to create some figures that examine all 50 states as well as D.C., Puerto Rico, and the Virgin Islands. 

### Figure 2: All States and their Average SAT Scores

To further see if there are significant differences in SAT scores across states, we decided to make a plot with boxplots of all states. 

```{r figure 2}
schooldata3 <- schooldata %>% 
  mutate(Total.Score = Total.Math + Total.Verbal) %>% 
  select("State.Code", "Total.Score") %>% 
  group_by(State.Code)

schooldata3

schooldata3 %>% ggplot(aes(x = reorder(State.Code, Total.Score), y = Total.Score), outlier.colour = NULL) + 
  geom_boxplot() + scale_x_discrete(guide = guide_axis(n.dodge=2)) + 
  labs(x = "SAT Score", y = "State")
```
Here we can see that across all U.S. territories there are notable differences in median SAT scores between them. This plot shows Iowa with the highest median SAT score, which could be explained by the fact that the Midwest dominates the SAT according to a Forbes article. This will be further discussed in our next figure, as we opted to look at the SAT scores across different regions of the continental U.S.

### Figure 3: Map of Average Total Score by State

To further confirm that the Midwest has the highest SAT scores, we created a grid of SAT scores by regions and created a heat map of the United States below.

```{r figure 3}
# map of average total score by state
library(maps)

schooldata4 <- schooldata %>% 
  mutate(Total.Score = Total.Math + Total.Verbal) %>% 
  select("State.Name", "Total.Score") %>% 
  group_by(State.Name) %>% 
  transmute(avg.total.score = mean(Total.Score), State.Name)
schooldata4 <- unique(schooldata4)

MainStates <- map_data("state")
states <- MainStates %>% transmute(region) %>% unique()
schooldata4 <- schooldata4 %>% transmute(region = str_to_lower(State.Name), avg.total.score) %>% 
  filter(region %in% states$region)

MergedStates <- inner_join(MainStates, schooldata4, by = "region")

ggplot() + geom_polygon(data = MergedStates, aes(x = long, y = lat, group = group, 
                                                 fill = avg.total.score), color = "white") +
  scale_fill_continuous(low = "springgreen", high = "springgreen4", name = "Average SAT Score") + 
  labs(title = "Average SAT Score by State")
```

### Figure 4: Breakdown of Average SAT Scores by Region

```{r figure 4}
west <- c("WA","OR", "ID", "MT", "WY", "CA", "NV", "UT", "CO")
southwest <- c("AZ", "NM", "OK", "TX")
midwest <- c("ND", "SD", "NE", "KS", "MN", "IA", "MO", "WI", "IL", "MI", "IN", "OH")
southeast <- c("LA", "MS", "TN", "KY", "WV", "VA", "NC", "SC", "AL", "GA", "FL", "AR")
northeast <- c("MA", "MD", "DE", "NJ", "ME", "VT", "NH", "PA", "NY", "CT", "RI")
continental_us <- c(west, southwest, midwest, southeast, northeast)
state_codes <- schooldata %>% select(State.Code) %>% unique() %>% filter(State.Code %in% continental_us)

schooldata5 <- schooldata %>% 
  mutate(Total.Score = Total.Math + Total.Verbal) %>% 
  select("State.Code", "Total.Score", "Year") %>% 
  add_column(region = NA) %>% 
  mutate(region = ifelse(State.Code %in% west, "West", region)) %>% 
  mutate(region = ifelse(State.Code %in% southwest, "Southwest", region)) %>% 
  mutate(region = ifelse(State.Code %in% midwest, "Midwest", region)) %>% 
  mutate(region = ifelse(State.Code %in% southeast, "Southeast", region)) %>% 
  mutate(region = ifelse(State.Code %in% northeast, "Northeast", region)) %>% 
  group_by(region) %>% 
  mutate(region = ifelse(!State.Code %in% continental_us, "Noncontiguous", region))

continental_us <- schooldata$State.Code %>% unique()
#continental_us

schooldata5 %>% ggplot(aes(Total.Score, State.Code, col = region)) + 
  facet_wrap(~region, scales = "free") + geom_point()
```

From both figures we see that the Midwest indisputedly has the highest SAT scores overall. This seemed odd to us, so we did a bit of research and found that it has been a repeating pattern for students in the Midwest to dominate the exam. As it turns out, from a Forbes article (https://www.forbes.com/sites/bentaylor/2014/07/17/why-the-midwest-dominates-the-sat/?sh=15c87cf72f37), we learned that most students in the Midwest opt to not take any standardized college entrance exams, and if they do, most choose to only take the ACT. Thus, the majority of the students taking the SAT in the Midwest are the very "best" students; that is, students who want to attend the most presitigious colleges, most of whose applications require an SAT score, so the overall scores are higher. 

### Figure 5: Income Bracket and Average SAT Scores

Our second figure shows the avergae SAT score across the six income brackets in our dataset. 

```{r figure 5}
# this needs to be fixed — use something other than geom_col
# Big Picture page idea: put the lowest and highest brackets
incomescore <- read_csv(here::here("dataset/incomescore.csv"))
incomescore <- incomescore %>% 
  mutate(average.total.score.of.bracket = average.math.score.of.bracket + average.verbal.score.of.bracket) %>% 
  mutate(income.bracket = str_remove(income.bracket, "income.between.")) %>%
  mutate(income.bracket = str_remove(income.bracket, "income.less.than.")) %>%
  mutate(income.bracket = str_remove(income.bracket, "income.more.than.")) %>%
  select("state.code", "income.bracket", "average.total.score.of.bracket") %>% 
  group_by(income.bracket) 
incomescore

incomescore_pivoted <- incomescore %>%
  select("income.bracket", "average.total.score.of.bracket") %>%
  group_by(income.bracket) %>%
  summarise(average.total.score.of.bracket = mean(average.total.score.of.bracket))
incomescore_pivoted

ggplot(data = incomescore_pivoted, 
       mapping = aes(x = income.bracket, 
                     y = average.total.score.of.bracket, 
                     fill = income.bracket)) + 
  geom_col(aes(color = income.bracket)) + 
  labs(x = "Income Bracket", y = "Average SAT Score of Bracket") 
```

Figure 5 examines the relationship between income bracket and average SAT score. Clearly, we see a steady rise in SAT score as the income bracket increases, which does support our hypothesis that income is the best predictor of SAT score. Interestingly, the biggest gap in SAT scores seems to be in between the "income under 20k" and the "income between 20 and 40k" brackets, which could indicate that those in the lowest income bracket faces the most difficulty in doing well on the exam. This makes sense, as there have been many studies showing that the stress of living in poverty negatively affects how one's brain functions. 

### Figure 5 Inference:

```{r figure 5 inference}
income <- c(20000, 40000, 60000, 80000, 100000)
incomescore <- c(936, 1040, 1090, 1114, 1143)
lm2 <- data.frame(cbind(income, incomescore))
summary(lm(incomescore ~ income, lm2))
```

We see here that there is a very strong positive correlation between income bracket and SAT score, as the R^2 value is very high and the absolute value of the t-stat for income is greater than 2.

### Figure 6: SAT Scores by Gender, 2005-2015

```{r figure 6}
# gender vs. sat score
genderscore <- read_csv(here::here("dataset/genderscore.csv"))

# genderscore <- genderscore %>%
#   pivot_longer(c(female.total.score, male.total.score), 
#                names_to = "gender", 
#                values_to = "average.SAT.score", 
#                values_drop_na = TRUE) %>%
#   mutate(gender = str_remove(gender, ".total.score"))

genderscore <- genderscore %>% group_by(year) %>% mutate(avg.female.SAT.score = mean(female.total.score), avg.male.SAT.score = mean(male.total.score))

ggplot(genderscore) + geom_point(aes(x = year, y = avg.female.SAT.score, col = "female")) + geom_point(aes(x = year, y = avg.male.SAT.score, col = "male")) + labs(x = "Year", y = "Average SAT Score", col = "Gender", title = "Average SAT Score By Gender from 2005-2015")
```

```{r figure 6 inference}
#checking if gender is a significant predictor of SAT score — yes!
genderscore_pivoted <- genderscore %>%
  pivot_longer(c(female.total.score, male.total.score), 
                names_to = "gender", 
                values_to = "average.SAT.score", 
                values_drop_na = TRUE) %>%
  mutate(gender = str_remove(gender, ".total.score")) %>%
  select("year", "state.code", "gender", "average.SAT.score")

genderdummies <- genderscore_pivoted %>%
  add_column(gdummy = NA) %>%
  mutate(gdummy = ifelse(gender == "female", 1, 0)) %>%
  select("year", "gdummy", "average.SAT.score")

summary(lm(average.SAT.score ~ gdummy, data = genderdummies))

```

### Backwards Selection Model

```{r backwards selection}
library(leaps)

bs <- leaps::regsubsets(
  average.total.score.of.bracket ~ .,
  method = "backward",
  data = incomescore
)

summary(bs)$which
summary(bs)$cp

```

Lastly, we decided to use backward selection to drop any predictor variables that made our model less precise. Our model 8 is the best model from the output since it has the lowest Mallow's CP value, and contains all the income bracket variables, indicating that income is indeed a good predictor of SAT scores. 

```